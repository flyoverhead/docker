---

- name: geofiles | latest release {{ geofile.name }}
  delegate_to: localhost
  ansible.builtin.uri:
    url: https://api.github.com/repos/{{ geofile.repo }}/releases/latest
  register: geofile_latest_release

- name: geofiles | download {{ geofile.name }}
  delegate_to: localhost
  ansible.builtin.get_url:
    url: '{{ geofile_asset.browser_download_url }}'
    dest: '{{ role_path }}/files/geosite/{{ geofile.name }}.dat'
    mode: '0644'
  loop: '{{ geofile_latest_release.json.assets }}'
  loop_control:
    label: '{{ geofile.file }}'
    loop_var: geofile_asset
  when:
    - geofile.file == geofile_asset.name
  register: geofile_download
  until: geofile_download is succeeded

- name: geofiles | copy {{ geofile.name }}
  become: true
  ansible.builtin.copy:
    src: '{{ role_path }}/files/geosite/{{ geofile.name }}.dat'
    dest: '{{ xray_docker_config.path }}/data/{{ geofile.name }}.dat'
    mode: '0644'
  loop: '{{ geofile_latest_release.json.assets }}'
  loop_control:
    label: '{{ geofile.file }}'
    loop_var: geofile_asset
  when:
    - geofile.file == geofile_asset.name
